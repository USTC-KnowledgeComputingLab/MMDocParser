when:
  event: [push, pull_request]

variables:
  - &pip-config
    PIP_DISABLE_PIP_VERSION_CHECK: true
    PIP_INDEX_URL: https://mirrors.ustc.edu.cn/pypi/simple
    PIP_PROGRESS_BAR: off
    PIP_ROOT_USER_ACTION: ignore

steps:
  woodpecker:
    image: woodpeckerci/woodpecker-cli:v${CI_SYSTEM_VERSION}-alpine
    environment:
      WOODPECKER_PLUGINS_PRIVILEGED: woodpeckerci/plugin-docker-buildx:5
    commands:
      - woodpecker-cli lint
    when:
      path: ".woodpecker/**"

  create-venv:
    image: python:3.12
    environment: *pip-config
    commands:
      - pip install uv
      - uv venv
      - uv pip install --group bandit --group mypy --group ruff --group secret
      - echo "PYPI_MIRROR=$PIP_INDEX_URL" > envvars

  docker:
    image: woodpeckerci/plugin-docker-buildx:5
    settings:
      repo: git.kclab.cloud/sci-agent/${CI_REPO_NAME}
      platforms: linux/amd64,linux/arm64
      env_file: envvars
      build_args_from_env:
        - PYPI_MIRROR
      dry-run: true
      output: type=image
    depends_on: [create-venv]
    when:
      path:
        include:
          - ".woodpecker/.validate.yaml"
          - "Dockerfile"
          - "pyproject.toml"

  bandit:
    image: python:3.12
    commands:
      - .venv/bin/bandit -c pyproject.toml -r .
    depends_on: [create-venv]

  mypy:
    image: python:3.12
    commands:
      - .venv/bin/mypy .
    depends_on: [create-venv]

  ruff:
    image: python:3.12
    commands:
      - .venv/bin/ruff check .
    depends_on: [create-venv]

  secrets:
    image: python:3.12
    commands:
      - .venv/bin/detect-secrets-hook --baseline .secrets.baseline
    depends_on: [create-venv]
